// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  password     String
  name         String
  role         String        @default("STUDENT")
  tier         String        @default("FREE")
  avatar       String?
  createdAt    DateTime      @default(now())
  
  // Subscription details
  subscriptionType   String?   // ANNUAL or LIFETIME for PAID users
  subscriptionExpiry DateTime? // Expiry date for annual subscriptions
  
  // Learning progress tracking
  lastInstitute String?       // Last selected institute
  lastLevel     Int?          // Last selected level
  lastUnit      Int?          // Last selected unit
  lastModule    String?       // Last active module (VOCAB, READING, LISTENING, GRAMMAR)

  savedWords         SavedWord[]
  mistakes           Mistake[]
  annotations        Annotation[]
  examHistory        ExamAttempt[]
  learningActivities LearningActivity[]
}

model Institute {
  id     String @id
  name   String
  levels String
}

model TextbookContent {
  key                  String  @id
  generalContext       String?
  vocabularyList       String?
  readingText          String?
  readingTranslation   String?
  readingTitle         String?
  listeningScript      String?
  listeningTranslation String?
  listeningTitle       String?
  listeningAudioUrl    String?
  grammarList          String?
  isPaid               Boolean @default(false) // Whether this unit requires paid subscription
}

model TopikExam {
  id          String   @id
  title       String
  round       Int
  type        String
  paperType   String?
  timeLimit   Int
  audioUrl    String?
  description String?  @db.Text
  questions   Json
  createdAt   DateTime @default(now())
  isPaid      Boolean  @default(false) // Whether this exam requires paid subscription
}

model SavedWord {
  id                 String   @id @default(uuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id])
  korean             String
  english            String
  pos                String?
  exampleSentence    String?
  exampleTranslation String?
  unit               Int?
  createdAt          DateTime @default(now())
}

model Mistake {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  korean    String
  english   String
  createdAt DateTime @default(now())
}

model Annotation {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  contextKey    String
  startOffset   Int?
  endOffset     Int?
  sentenceIndex Int?
  text          String
  color         String?
  note          String?
  createdAt     DateTime @default(now())
}

model ExamAttempt {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  examId      String
  examTitle   String
  score       Int
  maxScore    Int
  userAnswers Json
  timestamp   DateTime @default(now())
}

model LearningActivity {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  activityType  String   // 'VOCAB', 'READING', 'LISTENING', 'GRAMMAR', 'EXAM'
  duration      Int?     // Duration in minutes
  itemsStudied  Int?     // Number of words/questions/passages studied
  metadata      Json?    // JSON for additional data
  createdAt     DateTime @default(now())
  date          DateTime @default(now()) // Date part for daily tracking

  @@index([userId, date])
}

model LegalDocument {
  id        String   @id // 'terms', 'privacy', 'refund'
  title     String
  content   String   @db.Text
  updatedAt DateTime @default(now())
  updatedBy String?  // Admin user ID who updated it
}

model DailyPhrase {
  id           String   @id @default(uuid())
  korean       String   // 韩文句子，例如：좋은 하루 되세요!
  romanization String   // 发音，例如：Jo-eun ha-ru doe-se-yo!
  chinese      String   // 中文翻译
  english      String?  // 英文翻译（可选）
  dayIndex     Int      @unique // 第几天（1-365，循环使用）
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Canvas 笔迹/板书数据
model CanvasAnnotation {
  id         String   @id @default(uuid())
  userId     String
  targetType String   // "TEXTBOOK" 或 "EXAM"
  targetId   String   // 对应的内容ID
  pageIndex  Int      // 第几页
  data       Json     // 存储 Canvas 笔迹数据
  visibility String   @default("PRIVATE") // PRIVATE, PUBLIC, CLASS
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([targetType, targetId])
  @@index([userId, targetType, targetId])
}

// 用户学习进度
model UserProgress {
  id          String   @id @default(uuid())
  userId      String
  contentType String   // 内容类型
  contentId   String   // 内容ID
  progress    Int      @default(0) // 进度百分比
  completed   Boolean  @default(false)
  isHomework  Boolean  @default(false) // 是否为作业
  assignedBy  String?  // 布置作业的老师ID（可选）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, contentType, contentId])
  @@index([userId])
  @@index([assignedBy])
}
