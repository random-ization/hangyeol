import React, { useState, useEffect, useCallback } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { api } from '../../../services/api';
import { TopikExam, Language } from '../../../types';
import ExamPaperViewer from './components/ExamPaperViewer';
import { CanvasData } from '../annotation/components/CanvasLayer';
import { ChevronLeft, ChevronRight, Hand, Pencil, ArrowLeft, Clock } from 'lucide-react';

interface ExamSessionContainerProps {
    language?: Language;
}

/**
 * ExamSessionContainer - è€ƒè¯•ä¼šè¯é¡µé¢çº§ç»„ä»¶
 * 
 * åŠŸèƒ½ï¼š
 * - è·å–è¯•å·æ•°æ®
 * - ç®¡ç†å½“å‰é¢˜å·å’Œç”¨æˆ·ç­”æ¡ˆ
 * - åˆ‡æ¢ç­”é¢˜/è‰ç¨¿æ¨¡å¼
 * - è‡ªåŠ¨åŠ è½½/ä¿å­˜ç”»æ¿ç¬”è®°
 */
const ExamSessionContainer: React.FC<ExamSessionContainerProps> = ({
    language = 'ko' as Language,
}) => {
    const { examId } = useParams<{ examId: string }>();
    const navigate = useNavigate();

    // è¯•å·æ•°æ® - ç›´æ¥ä» DataContext è·å–
    const [exam, setExam] = useState<TopikExam | null>(null);
    const [examLoading, setExamLoading] = useState(true);

    // å½“å‰é¢˜å·
    const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);

    // ç”¨æˆ·ç­”æ¡ˆ
    const [answers, setAnswers] = useState<Record<number, number>>({});

    // ç»˜å›¾æ¨¡å¼
    const [isDrawing, setIsDrawing] = useState(false);

    // ç”»æ¿æ•°æ®
    const [canvasData, setCanvasData] = useState<CanvasData | null>(null);
    const [canvasLoading, setCanvasLoading] = useState(false);
    const [canvasSaving, setCanvasSaving] = useState(false);

    // è€ƒè¯•è®¡æ—¶ï¼ˆå¯é€‰ï¼‰
    const [elapsedTime, setElapsedTime] = useState(0);

    // è·å–è¯•å·æ•°æ® - åªåœ¨ examId å˜åŒ–æ—¶è·å–ä¸€æ¬¡
    useEffect(() => {
        const fetchExam = async () => {
            if (!examId) {
                setExamLoading(false);
                return;
            }

            setExamLoading(true);
            try {
                const exams = await api.getTopikExams();
                const found = exams.find((e: TopikExam) => e.id === examId);
                setExam(found || null);
            } catch (error) {
                console.error('Failed to fetch exam:', error);
                setExam(null);
            } finally {
                setExamLoading(false);
            }
        };

        fetchExam();
    }, [examId]);

    // è·å–å½“å‰é¢˜ç›®çš„ç”»æ¿ç¬”è®°
    const fetchCanvasAnnotation = useCallback(async () => {
        if (!examId) return;

        setCanvasLoading(true);
        try {
            const annotations = await api.getCanvasAnnotations({
                targetId: examId,
                targetType: 'EXAM',
                pageIndex: currentQuestionIndex,
            });

            if (annotations && annotations.length > 0) {
                setCanvasData(annotations[0].data as CanvasData);
            } else {
                setCanvasData(null);
            }
        } catch (error) {
            console.error('Failed to fetch canvas annotation:', error);
            setCanvasData(null);
        } finally {
            setCanvasLoading(false);
        }
    }, [examId, currentQuestionIndex]);

    // åˆ‡é¢˜æ—¶åŠ è½½ç”»æ¿æ•°æ®
    useEffect(() => {
        fetchCanvasAnnotation();
    }, [fetchCanvasAnnotation]);

    // ä¿å­˜ç”»æ¿ç¬”è®°
    const handleCanvasSave = useCallback(async (data: CanvasData) => {
        if (!examId) return;

        setCanvasSaving(true);
        try {
            await api.saveCanvasAnnotation({
                targetId: examId,
                targetType: 'EXAM',
                pageIndex: currentQuestionIndex,
                data,
            });
            console.log('[ExamSession] Canvas saved');
        } catch (error) {
            console.error('Failed to save canvas annotation:', error);
        } finally {
            setCanvasSaving(false);
        }
    }, [examId, currentQuestionIndex]);

    // å¤„ç†ç”»æ¿æ•°æ®å˜åŒ–ï¼ˆå¸¦é˜²æŠ–ä¿å­˜ï¼‰
    const canvasSaveTimeoutRef = React.useRef<NodeJS.Timeout | null>(null);
    const handleCanvasChange = useCallback((data: CanvasData) => {
        setCanvasData(data);

        // é˜²æŠ–ä¿å­˜ï¼ˆ2ç§’ï¼‰
        if (canvasSaveTimeoutRef.current) {
            clearTimeout(canvasSaveTimeoutRef.current);
        }
        canvasSaveTimeoutRef.current = setTimeout(() => {
            handleCanvasSave(data);
        }, 2000);
    }, [handleCanvasSave]);

    // å¤„ç†ç­”æ¡ˆé€‰æ‹©
    const handleAnswerChange = useCallback((questionIndex: number, optionIndex: number) => {
        setAnswers(prev => ({
            ...prev,
            [questionIndex]: optionIndex,
        }));
    }, []);

    // ç¿»é¡µ
    const totalQuestions = exam?.questions?.length || 0;
    const canGoPrev = currentQuestionIndex > 0;
    const canGoNext = currentQuestionIndex < totalQuestions - 1;

    const goToPrevQuestion = useCallback(() => {
        if (canGoPrev) {
            setCurrentQuestionIndex(prev => prev - 1);
        }
    }, [canGoPrev]);

    const goToNextQuestion = useCallback(() => {
        if (canGoNext) {
            setCurrentQuestionIndex(prev => prev + 1);
        }
    }, [canGoNext]);

    // è®¡æ—¶å™¨
    useEffect(() => {
        const timer = setInterval(() => {
            setElapsedTime(prev => prev + 1);
        }, 1000);
        return () => clearInterval(timer);
    }, []);

    const formatTime = (seconds: number) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    };

    // ç»„ä»¶å¸è½½æ—¶ä¿å­˜æœªä¿å­˜çš„æ•°æ®
    useEffect(() => {
        return () => {
            if (canvasSaveTimeoutRef.current) {
                clearTimeout(canvasSaveTimeoutRef.current);
            }
        };
    }, []);

    // åŠ è½½ä¸­
    if (examLoading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-slate-50">
                <div className="text-center">
                    <div className="w-16 h-16 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-4 mx-auto" />
                    <p className="text-slate-500">åŠ è½½è¯•å·ä¸­...</p>
                </div>
            </div>
        );
    }

    // è¯•å·ä¸å­˜åœ¨
    if (!exam) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-slate-50">
                <div className="text-center">
                    <p className="text-slate-500 mb-4">è¯•å·ä¸å­˜åœ¨</p>
                    <button
                        onClick={() => navigate(-1)}
                        className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                    >
                        è¿”å›
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-slate-50 flex flex-col">
            {/* é¡¶éƒ¨å·¥å…·æ  */}
            <header className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-30 shadow-sm">
                <div className="flex items-center gap-4">
                    <button
                        onClick={() => navigate(-1)}
                        className="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-medium transition-colors"
                    >
                        <ArrowLeft className="w-4 h-4" />
                        è¿”å›
                    </button>
                    <div className="h-6 w-px bg-slate-200" />
                    <div>
                        <h1 className="text-lg font-bold text-slate-800 truncate max-w-md">
                            {exam.title}
                        </h1>
                        <p className="text-xs text-slate-400">
                            ç¬¬ {currentQuestionIndex + 1} / {totalQuestions} é¢˜
                        </p>
                    </div>
                </div>

                <div className="flex items-center gap-4">
                    {/* è®¡æ—¶å™¨ */}
                    <div className="flex items-center gap-2 text-slate-500 bg-slate-100 px-3 py-1.5 rounded-lg">
                        <Clock className="w-4 h-4" />
                        <span className="font-mono text-sm">{formatTime(elapsedTime)}</span>
                    </div>

                    {/* ç­”é¢˜/è‰ç¨¿æ¨¡å¼åˆ‡æ¢ */}
                    <div className="flex bg-slate-100 p-1 rounded-lg">
                        <button
                            onClick={() => setIsDrawing(false)}
                            className={`flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-all ${!isDrawing
                                ? 'bg-white shadow-sm text-indigo-600'
                                : 'text-slate-500 hover:text-slate-700'
                                }`}
                        >
                            <Hand className="w-4 h-4" />
                            ğŸ–ï¸ ç­”é¢˜
                        </button>
                        <button
                            onClick={() => setIsDrawing(true)}
                            className={`flex items-center gap-2 px-4 py-2 rounded-md font-medium transition-all ${isDrawing
                                ? 'bg-white shadow-sm text-amber-600'
                                : 'text-slate-500 hover:text-slate-700'
                                }`}
                        >
                            <Pencil className="w-4 h-4" />
                            âœï¸ è‰ç¨¿
                        </button>
                    </div>

                    {/* ä¿å­˜çŠ¶æ€ */}
                    {canvasSaving && (
                        <span className="text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded">
                            ä¿å­˜ä¸­...
                        </span>
                    )}
                </div>
            </header>

            {/* ä¸»å†…å®¹åŒºåŸŸ */}
            <main className="flex-1 overflow-y-auto">
                <div className="max-w-4xl mx-auto py-6">
                    <ExamPaperViewer
                        questions={exam.questions || []}
                        currentQuestionIndex={currentQuestionIndex}
                        userAnswers={answers}
                        onAnswerChange={handleAnswerChange}
                        language={language}
                        showCorrect={false}
                        isDrawing={isDrawing}
                        onDrawingChange={setIsDrawing}
                        canvasData={canvasData}
                        onCanvasChange={handleCanvasChange}
                        onCanvasSave={handleCanvasSave}
                        contextPrefix={`exam-${examId}`}
                    />
                </div>
            </main>

            {/* åº•éƒ¨å¯¼èˆª */}
            <footer className="bg-white border-t border-slate-200 px-6 py-4 flex items-center justify-between sticky bottom-0 z-30 shadow-lg">
                <button
                    onClick={goToPrevQuestion}
                    disabled={!canGoPrev}
                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${canGoPrev
                        ? 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                        : 'bg-slate-50 text-slate-300 cursor-not-allowed'
                        }`}
                >
                    <ChevronLeft className="w-5 h-5" />
                    ä¸Šä¸€é¢˜
                </button>

                {/* é¢˜å·å¿«é€Ÿè·³è½¬ */}
                <div className="flex items-center gap-2 overflow-x-auto max-w-md">
                    {Array.from({ length: totalQuestions }, (_, i) => (
                        <button
                            key={i}
                            onClick={() => setCurrentQuestionIndex(i)}
                            className={`w-8 h-8 rounded-lg text-sm font-medium transition-all ${i === currentQuestionIndex
                                ? 'bg-indigo-600 text-white'
                                : answers[i] !== undefined
                                    ? 'bg-green-100 text-green-700 border border-green-200'
                                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                }`}
                        >
                            {i + 1}
                        </button>
                    ))}
                </div>

                <button
                    onClick={goToNextQuestion}
                    disabled={!canGoNext}
                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${canGoNext
                        ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md'
                        : 'bg-slate-50 text-slate-300 cursor-not-allowed'
                        }`}
                >
                    ä¸‹ä¸€é¢˜
                    <ChevronRight className="w-5 h-5" />
                </button>
            </footer>
        </div>
    );
};

export default ExamSessionContainer;
